<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, shrink-to-fit=no"> 
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
        <title>Checkout</title>
    </head>
   <body id="body" style="padding-top: 85px; background-color: #D5D5E0;">
   <nav class="navbar navbar-dark bg-dark navbar-expand-sm fixed-top">
	<div class="container">
            <a class="navbar-brand">
		<img alt="logo" width="40" height="40" src="https://demo.tastyigniter.com/assets/media/uploads/tastyigniter-logo.png">
            </a>
            <div class="collapse navbar-collapse">
		<ul class="navbar-nav ml-auto">
                    <li class="nav-item">
			<a id="view_menu" class="nav-link">View Menu</a>
                    </li>
                    <li class="nav-item">
			<a id="login" class="nav-link">Login</a>
                    </li>
                    <li class="nav-item">
			<a id="register" class="nav-link">Register</a>
                    </li>
		</ul>
            </div>
	</div>
    </nav>
    <div id="central" class="container">
        <form id="data-form" class="needs-validation" novalidate>
        <div class="row">
            <div class="col-8 bg-white rounded py-4">
                <div class="container-fluid bg-white mb-1 rounded">
			<div class="dropdown py-3">
                            <button class="btn border-primary btn-light btn-block rounded dropdown-toggle text-truncate" 
                            type="button" id="OrderTimePicker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<b>ASAP</b>
                            </button>
                            <div class="dropdown-menu text-center" aria-labelledby="OrderTimePicker">
                                <button id="asap" class="btn btn-outline-primary btn-block py-2">
                                    ASAP
                                </button>
                                <div class="dropdown-divider"></div>
                                <input type="datetime-local" id="daytime">  
                                <button id="schedule_order" type="button" class="btn btn-outline-primary btn-sm py-2">
                                    Schedule Order
                                </button>
                            </div>
			</div>
                </div>
                <!--<form class="needs-validation" novalidate>-->
                    <div class="form-row">
                      <div class="col-6">
                        <label for="first-name">First name</label>
                        <input type="text" class="form-control" id="first-name" placeholder="First name" value="" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>
                      <div class="col-6">
                        <label for="validationCustom02">Last name</label>
                        <input type="text" class="form-control" id="validationCustom02" placeholder="Last name" value="Otto" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>
                    </div>
                    <div class="form-row">
                        <div class="col-6"> 
                        <label for="email">Email</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text" id="inputGroupPrepend">@</span>
                          </div>
                          <input type="email" class="form-control" id="email" aria-describedby="emailHelp" placeholder="Enter email" required>
                          <div class="invalid-feedback">
                            Please choose a Email.
                          </div>
                      </div>
                      </div>
                      <div class="col-6">
                        <label for="example-tel-input">Telephone</label>
                        <input class="form-control" type="tel" value="" id="telefono" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>   
                    </div>
                    <div class="form-row">
                        <div class="col-6">
                            <label for="inputAddress1">Address 1</label>
                            <input type="text" class="form-control" id="inputAddress1" placeholder="Address" required>
                            <div class="invalid-feedback">
                                Please choose an Address.
                            </div>
                        </div>
                        <div class="col-6">
                            <label for="inputAddress2">Address 2</label>
                            <input type="text" class="form-control" id="inputAddress2" placeholder="Address">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-12">
                        <label for="exampleSelect1">Delivering to...</label>
                        <select class="form-control" id="exampleSelect1">
                            <option value="0">Enter a new or an existing delivery address.</option>
                        </select>
                    </div>
                    </div>
                    <div class="form-row">
                      <div class="col-md-6 mb-3">
                        <label for="validationCustom03">City</label>
                        <input type="text" class="form-control" id="validationCustom03" placeholder="City" required>
                        <div class="invalid-feedback">
                          Please provide a valid city.
                        </div>
                      </div>
                      <div class="col-md-3 mb-3">
                        <label for="validationCustom04">State</label>
                        <input type="text" class="form-control" id="validationCustom04" placeholder="State" required>
                        <div class="invalid-feedback">
                          Please provide a valid state.
                        </div>
                      </div>
                      <div class="col-md-3 mb-3">
                        <label for="validationCustom05">Postcode</label>
                        <input type="text" class="form-control" id="validationCustom05" placeholder="Postcode" required>
                        <div class="invalid-feedback">
                            Please provide a valid Postcode.
                        </div>
                      </div>
                    </div>
            </div>
            <div class="col-4"> 
                <div class="container-fluid bg-white rounded mb-1">
                    <div class="container py-2">
			<!-- BOTONES DE DELIVERY Y PICKUP -->
			<div id="way"  class="btn-block btn-group btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-outline-primary active">
                                <input type="radio" id="delivery" name="options" autocomplete="off" checked>
    				<b>Delivery</b>
                            </label>
                            <label class="btn btn-outline-primary">
    				<input type="radio" id="pickup" name="options" id="pickup" autocomplete="off">
    				<b>Pickup</b>
                            </label>
			</div>
                    </div>
                    <br>
                    <div id="dishes-container" class="container-fluid pb-1">
                        
                    </div>
		</div>
		<div class="container-fluid bg-white rounded mb-1 pb-2">
                    <div class="row py-2">
			<div class="col-4">
                            <div class="text-muted">Order-Total:</div>
			</div>	
                        <div class="col-8 text-right">
                            <div id="order-total"></div>
			</div>	
                    </div>
                    <button type="submit" id="confirm" class="btn btn-danger btn-block">Confirm</button>
		</div>
            </div>
        </div>
        </form>
    </div>
    <!-- Footer -->
    <footer id="footer" class="page-footer font-small mt-5">
	<div class="container-fluid bg-primary text-dark">
            <div class="row py-4">
		<div class="col-6">
                    <h5 class="text-right">FOOD SERVICE BY:</h5>
                </div>
		<div class="col-6">
                    <div class="h5 text-left">Kevin A. Flores</div>
                    <div class="h5 text-left">Luis D. Villalobos</div>
		</div>
            </div>
	</div>
    	<div class="footer-copyright text-center text-white bg-dark py-3">
            © 2020 Copyright.<br><h6 class="text-center">Universidad Nacional De Costa Rica</h6>
 	 </div>
    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        globalOrder=[];
        _dish_=null;
        _update_=false;
        _selected_=0;
        _hecho_=false;
        _confirm_=true;
        
        function init(){
            $("#view_menu").on("click",()=>{navbar(1);});
            $("#register").on("click",()=>{navbar(2);});
            $("#login").on("click",()=>{navbar(3);});
            
            $("#way").on("click",()=>{changeWayToReceive();});
            $("#asap").on("click",()=>{changeAsapDate(false);});
            $("#schedule_order").on("click",()=>{changeAsapDate(true);});
            $("#data-form").submit(function(event){verifyInputs(event);});
            loadOrderInit();
        }
        
        $(init);
        
        function navbar(numero){
            switch(numero){
                case 1:{
                  window.location="/Food_Service_PIV/web/presentation/client/order.html";      
                }
                case 2:{
                        
                }
                case 3:{
                    
                }
            }
        }
        
        function finishOrder(){
            $.ajax({
                type:"POST",
                url:"/Food_Service_PIV/web/api/orders/address/"+$("#inputAddress1").val(),
                contentType:"application/json"
            }).then(
                (order)=>{
                    $.ajax({
                        type:"POST",
                        url:"/Food_Service_PIV/web/api/orders/dateOrder/"+orderDate(),
                        contentType:"application/json"
                    }).then(
                        (order)=>{
                            var cli = {
                                name:$("#first-name").val(),
                                telephone:$("#telefono").val(),
                                lastName:$("#validationCustom02").val(),
                                password:"",
                                email:$("#email").val()
                            };
                            $.ajax({
                                type:"POST",
                                url:"/Food_Service_PIV/web/api/orders/client",
                                data:JSON.stringify(cli),
                                contentType:"application/json"
                            }).then(
                                (order)=>{finish(order);},
                                (error)=>{errorMessage(error.status,$("#dishes-container"));} 
                            );
                        },
                        (error)=>{errorMessage(error.status,$("#dishes-container"));} 
                    );
                },
                (error)=>{errorMessage(error.status,$("#dishes-container"));} 
            ); 
        }
        
        function finish(order){
            globalOrder = order.pop();
            var x = globalOrder.orderDate.split("T");
            $("#central").html(
                '<div class="container">'+
                    '<div class="row py-4">'+
                        '<div class="col-sm-9 m-auto">'+
                            '<div class="card mb-1">'+
                                '<div class="card-body text-sm-center">'+
                                    '<div class="label label-light mb-3">'+
                                    '<span class="h6">'+
                                        '&nbsp;'+x[0]+' '+x[1]+
                                    '</span>'+
                                '</div>'+
                                '<h5>Order #'+globalOrder.id+'</h5>'+
                                '<h3 style="color: #686663;">Received</h3>'+
                                '<p class="lead">Your order has been received.</p>'+
                                '<p class="mb-0">'+
                                    'Your order has been received and will be with you shortly.'+
                                '</p>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</div>'
            );
            $("#footer").addClass("fixed-bottom");
        }
        
        function orderDate(){
            var now = new Date();
            
            var day = ("0" + now.getDate()).slice(-2);
            var month = ("0" + (now.getMonth()+1)).slice(-2);
            var hour = ("0" + (now.getHours())).slice(-2);
            var min = ("0" + (now.getMinutes())).slice(-2);
            
            return now.getFullYear()+"-"+(month)+"-"+(day)+"T"+hour+":"+min;
        }
        
        function loadOrderInit(){
            $.ajax({
                type:"GET",
                url:"/Food_Service_PIV/web/api/orders/globalOrder",
                contentType:"application/json"
            }).then(
                (order)=>{updateOrder(order);},
                (error)=>{errorMessage(error.status,$("#dishes-container"));} 
            ); 
        }
        
        function updateOrder(order){
            globalOrder = order.pop();
            if(!_hecho_){
            if(globalOrder.deliveryDate === undefined){
                _hecho_=true;
                limitDatePicker();
            }else{
                var x = globalOrder.deliveryDate.substr(0,16);
                document.getElementById("daytime").value = x;
                changeAsapDate(true);
                limitDatePicker();
            }_hecho_=true;
            }
            showOrder(globalOrder.clientDishList);
            $("#order-total").html("₡"+globalOrder.total);
            return true;
        }
        
        function showOrder(dishList){
            var count = 0;
            var container = $("#dishes-container");
            container.html("");
            if(dishList.length === 0){
                container.html('<div class="text-center"><i>Add menu items to your cart.</i></div>');
                _confirm_=false;
                return;
            }else{_confirm_=true;}
            dishList.forEach((d)=>{
                var dish = $(
                    '<div class="row mb-2">'+
                        '<div class="col-2">'+
                            '<button type="button" id="delete-'+count+'" class="btn btn-outline-primary" style="padding: 0px 13px;">'+
                                '<b>-</b>'+
                            '</button>'+
                        '</div>'+
                        '<div class="col-7">'+
                            '<small class="text-uppercase">'+d.quantity+' x '+d.dishes.name+'</small>'+
                            '<div>'+
				'<small class="text-muted">'+
                                '<div>'+detailsString(d)+'</div>'+
				'</small>'+
                            '</div>'+
                        '</div>'+
                        '<div class="col-3"> ₡'+d.total+'</div>'+
                    '</div>'  
                    );
                var x = count;
                dish.find("#delete-"+x).on("click",()=>deleteDish(x));
                container.append(dish);
                count++;
            });
        }
        
        function detailsString(dish){
            if(dish.clienteAdditionalsList === undefined){return dish.dishes.decription;}
            var string = "";
            dish.clienteAdditionalsList.forEach((addi)=>{
                addi.clienteDetailsList.forEach((detail)=>{
                    string+=detail.details.name+" (₡"+detail.details.price+").<br>";
                });
            });
            return string;
        }
        
        function deleteDish(index){
            $.ajax({
                type:"DELETE",
                url:"/Food_Service_PIV/web/api/orders/delete/"+index,
                data:index,
                contentType:"application/json"
            }).then(
               (order)=>{updateOrder(order);},
               (error)=>{errorMessage(error.status,("#dishes-container"));}
            );
        }
    
        function changeAsapDate(x){
            if(x){
                $.ajax({
                    type:"PUT",
                    url:"/Food_Service_PIV/web/api/orders/schedule/"+document.getElementById("daytime").value,
                    contentType:"application/json"
                }).then(
                    (order)=>{globalOrder=order.pop(); updateAsapDate();},
                    (error)=>{errorMessage(error.status,$("#dishes-container"));} 
                ); 
            }else{
                $.ajax({
                    type:"PUT",
                    url:"/Food_Service_PIV/web/api/orders/schedule/asap",
                    contentType:"application/json"
                }).then(
                    (order)=>{globalOrder=order.pop(); updateAsapDate();},
                    (error)=>{errorMessage(error.status,$("#dishes-container"));} 
                ); 
            }
        }
        
        function updateAsapDate(){
            if(globalOrder.deliveryDate === undefined){
                $("#OrderTimePicker").html("<b>ASAP</b>");
            }else{
                var split = globalOrder.deliveryDate.split("T");
                var date = split[0];
                var time = split[1].split("-");
                var time_ = time[0].split(":");
                $("#OrderTimePicker").html("<b>"+date+" "+time_[0]+":"+time_[1]+"</b>");
            }
        }
        
        function limitDatePicker(){
            var now = new Date();
            var last = new Date();
            last.setDate(now.getDate()+5);
            
            var day = ("0" + now.getDate()).slice(-2);
            var month = ("0" + (now.getMonth()+1)).slice(-2);
            var hour = ("0" + (now.getHours())).slice(-2);
            var min = ("0" + (now.getMinutes())).slice(-2);
            
            var _day = ("0" + last.getDate()).slice(-2);
            var _month = ("0" + (last.getMonth()+1)).slice(-2);
            var _hour = ("0" + (last.getHours())).slice(-2);
            var _min = ("0" + (last.getMinutes())).slice(-2);
            
            var today_now = now.getFullYear()+"-"+(month)+"-"+(day)+"T"+hour+":"+min;
            var today_last = last.getFullYear()+"-"+(_month)+"-"+(_day)+"T"+_hour+":"+_min;
            
            document.getElementById("daytime").min = today_now;
            if(_hecho_){
                document.getElementById("daytime").value = today_now;
            }
            document.getElementById("daytime").max = today_last;   
        }
        
        function changeWayToReceive(){
            // 0 es delivery y 1 es pickup;
            var true_false  = 1;
            if(!$("#delivery").prop("checked") === true){
                true_false = 0;
            }
            $.ajax({
                type:"PUT",
                url:"/Food_Service_PIV/web/api/orders/receive/"+true_false,
                contentType:"application/json"
            }).then(
                (order)=>{globalOrder=order.pop();},
                (error)=>{errorMessage(error.status,$("#dishes-container"));} 
            );
        }
        
        function verifyInputs(event) {
            var forms = document.getElementsByClassName('needs-validation');
            if (forms[0].checkValidity() === false) {
                  event.preventDefault();
                  event.stopPropagation();
                }else{
                    event.preventDefault();
                    if(_confirm_){
                        finishOrder();
                    }
                }
            forms[0].classList.add('was-validated');
            if(!_confirm_){
                errorMessage(555,$("#dishes-container"));
                $("#dishes-container").append($('<div class="text-center"><i>Add menu items to your cart.</i></div>'));
            }
        }
    
        function errorMessage(status,place){
            error=status;
            switch(status){
                case 401: error= "Usuario no registrado"; break;
                case 403: case 405: error="Usuario no autorizado"; break;                
                case 404: error= "Registro no encontrado"; break;
                case 111: error="Debes Completar los Espacios Requeridos"; break;
                case 222: error="La cantidad no puede ser menor"; break;
                case 333: error="La cantidad no puede ser menor a 1"; break;
                case 555: error="Debes añadir elementos al carrito."; break;
            };            
            place.html('<div class="alert alert-danger fade show">' +
            '<button type="button" class="close" data-dismiss="alert">' +
            '&times;</button><h4 class="alert-heading">Error!</h4>'+error+'</div>');
            return;        
        }
    </script>
</body>
</html>
