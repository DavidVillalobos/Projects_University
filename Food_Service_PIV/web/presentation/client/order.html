<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <title>Pedido</title>
</head>
<body style="padding-top: 85px; background-color: #D5D5E0;">
    <nav class="navbar navbar-dark bg-dark navbar-expand-sm fixed-top">
	<div class="container">
            <a class="navbar-brand">
		<img alt="logo" width="40" height="40" src="https://demo.tastyigniter.com/assets/media/uploads/tastyigniter-logo.png">
            </a>
            <div class="collapse navbar-collapse">
		<ul class="navbar-nav ml-auto">
                    <li class="nav-item">
			<a href="#" class="nav-link">View Menu</a>
                    </li>
                    <li class="nav-item">
			<a href="#" class="nav-link">Login</a>
                    </li>
                    <li class="nav-item">
			<a href="#" class="nav-link">Register</a>
                    </li>
		</ul>
            </div>
	</div>
    </nav>
    <div class="container">
        <div class="row">
            <div class="col-2">
		<h5 class="px-3">Categories</h5>
		<div id="categories"></div>
            </div>
            <div class="col-6">
		<div class="container">
                    <div class="container-fluid bg-white mb-1 rounded">
			<div class="dropdown py-3">
                            <button class="btn border-primary btn-light btn-block rounded dropdown-toggle text-truncate" 
                            type="button" id="OrderTimePicker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<b>ASAP</b>
                            </button>
                            <div class="dropdown-menu" aria-labelledby="OrderTimePicker">
                                <button class="dropdown-item py-2">ASAP</button>
                                <div class="dropdown-divider"></div>
				<button class="dropdown-item py-2">Schedule Order</button>
                            </div>
			</div>
                    </div>
                    <div class="container-fluid bg-white mb-1 rounded">
			<div class="row py-3">
                            <div class="col-6">
				<h3 class="font-italic">Food Service</h3>
                                <div class="text-muted">345 Lewisham Road, London SE13 7AB, United Kingdom</div>
                            </div>
                            <div class="col-6">
                                <span class="text-success">We are open</span>
                                <div>24 hours, 7 days.</div>
                                <div class="text-muted">Delivery and pick-up available </div> 
                            </div>
			</div>
                    </div>
                    <div class="container-fluid bg-white rounded">
			<h6 class="text-primary px-1 py-3">Menu</h6>
                    </div>
                    <div id="selected-categories" class="container-fluid bg-white rounded">
                        <div id="new-seccion"></div>
                        <div class="modal fade" id="detail_popup" tabindex="-1" role="dialog" 
                        aria-labelledby="detail_popup_title" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="detail_popup_title"></h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div id="alert_popup"></div>
                                        <div id="detail_popup_body" class="container-fluid">
                                            
                                            <!-- MULTIPLE SELECTION -->
                                            <div class="row bg-light">
                                                <div class="col-8">
                                                    <h6 class="mb-0">Nombre Additional</h6>
                                                </div>
                                                <div class="col-4">
                                                    <p class="text-muted text-right mb-0">requerido</p>
                                                </div>
                                            </div>
                                            <div class="container-fluid bg-white">
                                                <div class="row">
                                                    <div class="col-8">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="" id="defaultCheck1">
                                                        <label class="form-check-label" for="defaultCheck1">
                                                            Detail 1
                                                        </label>    
                                                    </div>
                                                    </div>
                                                    <div class="col-4"><p class="text-right mb-0">3000</p></div>
                                                </div>
                                            </div>
                                            <!-- UNIQUE SELECTION -->
                                            <div class="row bg-light">
                                                <div class="col-8">
                                                    <h6 class="mb-0">Nombre Additional</h6>
                                                </div>
                                                <div class="col-4"><p class="text-right text-muted mb-0">requerido</p></div>
                                            </div>
                                            <div class="container-fluid bg-white">
                                                <div class="row">
                                                    <div class="col-8">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="exampleRadios" 
                                                        id="exampleRadios1" value="option1" checked>
                                                        <label class="form-check-label" for="exampleRadios1">
                                                            Detail radio
                                                        </label>
                                                    </div>
                                                    </div>
                                                    <div class="col-4"><p class="text-right mb-0">200</p></div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-8">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="exampleRadios" 
                                                        id="exampleRadios2" value="option2">
                                                        <label class="form-check-label" for="exampleRadios2">
                                                            detail radio 2
                                                        </label>
                                                    </div>
                                                    </div>
                                                    <div class="col-4"><p class="text-right mb-0">300</p></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="detail_popup_footer" class="modal-footer">
                                        <div class="row">
                                            <div class="col-5">
                                                <div class="input-group">
                                                    <input type="number" class="form-control  text-center" value="" placeholder="Cant" 
                                                    id="cant_popup" aria-label="Cant" aria-describedby="basic-addon2">
                                                    <div class="input-group-append">
                                                        <button id="plus_order_popup" class="btn btn-outline-secondary" type="button">+</button>
                                                        <button id="less_order_popup" class="btn btn-outline-secondary" type="button">-</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-7">
                                                <button id="add_order_popup" type="button" class="btn btn-primary btn-block">
                                                </button>
                                            </div>
                                        </div> 
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
		</div>
            </div>
            <div class="col-4">
		<div class="container-fluid bg-white rounded mb-1">
                    <div class="container py-2">
			<!-- BOTONES DE DELIVERY Y PICKUP -->
			<div class="btn-block btn-group btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-outline-primary active">
                                <input type="radio" name="options" id="option1" autocomplete="off" checked>
    				<b>Delivery</b>
                            </label>
                            <label class="btn btn-outline-primary">
    				<input type="radio" name="options" id="option2" autocomplete="off">
    				<b>Pickup</b>
                            </label>
			</div>
                    </div>
                    <br>
                    <div class="container-fluid pb-1">	
			<div class="row">
                            <div class="col-2">
				<button type="button" class="btn btn-outline-primary" style="padding: 0px 5px;">
                                    <b>-</b>
				</button>
                            </div>
                            <div class="col-7">
				<small class="text-uppercase">Nombre del Platillo</small>
                            </div>
                            <div class="col-3">
				c10.00000
                            </div>
			</div>
			<div class="row">
                            <div class="col-2"></div>
                            <div class="col-10">
				<small class="text-muted">
                                    <div>texto que tenga</div>
                                    <div>que ver con el </div>
                                    <div>platillo jejeps </div>
                                    <div>no tengo idea de que poner.</div>
				</small>
							</div>
			</div>
					</div>
		</div>
		<div class="container-fluid bg-white rounded mb-1 pb-2">
                    <div class="row py-2">
			<div class="col-4">
                            <div class="text-muted">Sub-Total:</div>
                            <div class="text-muted">Delivery:</div>
                            <div class="text-muted">Order-Total:</div>
			</div>	
                        <div class="col-8 text-right">
                            <div>c13023.324</div>
                            <div>c0</div>
                            <div>c13023.324</div>
			</div>	
                    </div>
                    <button class="btn btn-danger btn-block">Checkout</button>
		</div>
            </div>
	</div>
    </div>
    <!-- Footer -->
    <footer class="page-footer font-small mt-5">
	<div class="container-fluid bg-primary text-dark">
            <div class="row py-4">
		<div class="col-6">
                    <h5 class="text-right">FOOD SERVICE BY:</h5>
                </div>
		<div class="col-6">
                    <div class="h5 text-left">Kevin A. Flores</div>
                    <div class="h5 text-left">Luis D. Villalobos</div>
		</div>
            </div>
	</div>
    	<div class="footer-copyright text-center text-white bg-dark py-3">
            Â© 2020 Copyright.<br><h6 class="text-center">Universidad Nacional De Costa Rica</h6>
 	 </div>
    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        
        globalOrder=null;
        
        function init(){
            $("#plus_order_popup").on("click",()=>{
               $("#cant_popup").attr("value",parseInt($("#cant_popup").val(),10)+1);
            });
            $("#less_order_popup").on("click",()=>{
                var x = parseInt($("#cant_popup").val(),10);
                if(x>1){$("#cant_popup").attr("value",parseInt($("#cant_popup").val(),10)-1);}
                else{errorMessage(222,$("#alert_popup"));}
            });
            loadCategories();
        }
        
        $(init);
        
        function loadCategories(){
            $.ajax({
                type:"GET",
                url:"/Food_Service_PIV/web/api/orders/categories",
                contentType:"application/json" 
            }).then(
                (categories)=>{showCategories(categories);},
                (error)=>{errorMessage(error.status,$("#categories"));}
            );
        }
        
        function showCategories(categories){
            var list=$("#categories");
            list.html("");
            categories.forEach((c)=>{addCategorie(list,c);});
        }
        
        function addCategorie(list,c){
            var anchor=$('<a id="'+c.id+'" class="nav-link" href="#"></a>');
            anchor.html(c.name);
            anchor.on("click",()=>{verifySelectedCategorie(c.id);});
            list.append(anchor);
        }
        
        function verifySelectedCategorie(id){
            if($("#"+id).hasClass("text-danger")){
                $("#"+id).removeClass("text-danger");
                $("#div-"+id).remove();
            }
            else{
                $("#"+id).addClass("text-danger");
                loadDishes(id);
            }
        }
        
        function loadDishes(id){
            $.ajax({
                type:"GET",
                url:"/Food_Service_PIV/web/api/orders?categorie="+id,
                contentType:"application/json"
            }).then(
                (dishes)=>{showDishes(dishes);},
                (error)=>{errorMessage(error.status,$("#categories"));}
            );
        }
       
        function hasAdditionals(Dish,mainDiv){
            $.ajax({
                type:"GET",
                url:"/Food_Service_PIV/web/api/orders/hasAdditionals/"+Dish.id,
                contentType:"application/json"
            }).then(
                (additionals)=>{
                    if(additionals.length>0){
                        mainDiv.find("#add_button_"+Dish.id).attr("data-target","#detail_popup");
                    };
                    var y = mainDiv.find("#add_button_"+Dish.id);
                    var t = y.attr("data-target");
                    mainDiv.find("#add_button_"+Dish.id).on("click",()=>{validateDish(Dish, t==="#detail_popup");});
                },
                (error)=>{errorMessage(error.status,$("#selected-categories"));}            
            );
        }
        
        function showDishes(dishes){
            if(dishes.length > 0){
                var mainDiv=$("#new-seccion");
                mainDiv.attr("id","div-"+dishes[0].categories.id);
                mainDiv.addClass("py-1");
                var mainButton=$('<button class="btn btn-block btn-outline-dark" type="button" data-toggle="collapse"'+ 
                                 'data-target="#seccion-'+dishes[0].categories.id+'" aria-expanded="false">');
                mainButton.html("<h5>"+dishes[0].categories.name+"</h5>");
                mainDiv.append(mainButton);
                dishes.forEach((d)=>{
                    var newDish=$(
                    '<div id="seccion-'+d.categories.id+'" class="collapse">'+
			'<div class="row pt-2 pl-2">'+
                            '<div class="col-8">'+
				'<h6 class="text-uppercase">'+d.name+'</h6>'+
                                '<div><small class="text-muted text-justify">'+
                                    d.decription+
                                '</small></div>'+	
                            '</div>'+
                            '<div class="col-3 font-weight-bold text-right">'+
                                d.price+
                            '</div>'+
                            '<div class="col-1">'+
                                '<button id="add_button_'+d.id+'" type="button" class="btn btn-outline-primary"'+
                                ' data-toggle="modal" data-target="#DoNotHave"  style="float:right; padding: 0px 5px;">'+
                                    '<b>+</b>'+
                                '</button>'+
                            '</div>'+
			'</div>'+
                    '</div>'    
                    );
                    mainDiv.append(newDish);
                    hasAdditionals(d,mainDiv);
                });
                var selected=$("#selected-categories");
                selected.append(mainDiv);
                selected.append($('<div id="new-seccion"></div>'));
            }
        }
        
        function validateDish(dish,x){
            if(x){
                $.ajax({
                    type:"GET",
                    url:"/Food_Service_PIV/web/api/orders/details/"+dish.id,
                    contentType:"application/json"
                }).then(
                   (details)=>{updateDetailPopup(dish,details);},
                   (error)=>{errorMessage(error.status,("#detail_popup"));}
                );
            }else{
                //addToShoppingCart(dish,false); 
            }
        }
        
        function addToShoppingCart(_dish,additionalsFlag){
            itsOk=true;
            var clientDish={quantity:$("#cant_popup").attr("value"),dishes:{id:_dish.id}};
            if(additionalsFlag){
                var clientAdditionals=[];
                _dish.additionalsList.forEach((addi)=>{verifySelectedAdditional(addi,clientAdditionals);});
                clientDish.clienteAdditionalsList=clientAdditionals;
                if(parseInt($("#cant_popup").val(),10) < 1){
                    itsOk=false;
                errorMessage(333,$("#alert_popup"));
                }
            }
            var xd = JSON.stringify(clientDish);
            var xd_2= JSON.stringify(_dish);
            if(itsOk){
                $.ajax({
                   type:"POST",
                   url:"/Food_Service_PIV/web/api/orders",
                   data:xd,
                   contentType:"application/json"
               }).then(
                   (order)=>{updateOrder(order);},
                   (error)=>{errorMessage(error.status,("#alert_popup"));}
                );
            }
        }
        
        function updateOrder(order){
            return true;
        }
        
        function verifySelectedAdditional(addi,clientAddi){
            var oneSelected = false;
            var newClientAddi = {
                additionals:{id:addi.id}, //tengo todos los datos en addi
                clienteDetailsList:[]
            };
            var newAddi = {
                type:addi.type,
                name:addi.name,
                mandatory:addi.mandatory,
                id:addi.id,
                dishes:addi.dishes,
                detailsList:[]};
            if(addi.type){
                addi.detailsList.forEach((d)=>{
                    if($("#check_"+d.id).prop("checked")){
                        //newAddi.detailsList.push(d);
                        newClientAddi.clienteDetailsList.push({details:d});
                        oneSelected = true;
                    }
                });
            }
            else{
                var idDetail = $('input[name=grupo_'+addi.id+']:checked').val();
                addi.detailsList.forEach((d)=>{
                    if(""+d.id===idDetail){
                        //newAddi.detailsList.push(d);
                        newClientAddi.clienteDetailsList.push({details:d});
                        oneSelected=true;
                    }
                });  
            }
            if(addi.mandatory && !oneSelected){
                errorMessage(111,$("#alert_popup"));
                itsOk=false;
            }
            //clientAddi.push(newAddi);
            clientAddi.push(newClientAddi);
        }
        
        function removeItemFromArr ( arr, item ) {
            var i = arr.indexOf( item );
            if ( i !== -1 ) {
                arr.splice( i, 1 );
            }
        }
        function updateDetailPopup(dish,details){
            dish.additionalsList=details;
            $("#detail_popup_title").html(dish.name+'<br><small class="text-muted">'+dish.decription+'</small>');
            var popup_body=$("#detail_popup_body");
            popup_body.empty();
            details.forEach((d)=>{
                var newAdditional=$(
                '<div class="row bg-light">'+
                    '<div class="col-8">'+
                        '<h6 class="mb-0 text-uppercase">'+d.name+'</h6>'+
                    '</div>'+
                    '<div class="col-4">'+
                        '<p class="text-muted text-right mb-0">'+(d.mandatory?'Requerido':'')+'</p>'+
                    '</div>'+
                '</div>');
                d.detailsList.forEach((detail)=>{
                    var newDetail=$(
                    '<div class="container-fluid bg-white pt-1">'+
                        '<div class="row">'+
                            '<div class="col-8">'+
                                '<div class="form-check">'+
                                    '<input class="form-check-input" type="'+(d.type?'checkbox':'radio')+
                                    '" name="'+(d.type?'':'grupo_'+d.id)+'" value="'+detail.id+'" id="check_'+detail.id+'">'+
                                    '<label class="form-check-label" for="check_'+detail.id+'">'+
                                        detail.name+
                                    '</label>'+   
                                '</div>'+
                            '</div>'+
                            '<div class="col-4"><p class="text-right my-1">'+detail.price+'</p></div>'+
                        '</div>'+
                    '</div>');
                    newAdditional.append(newDetail);
                });
                popup_body.append(newAdditional);
            });
            $("#cant_popup").attr("value","1");
            $("#add_order_popup").html('ADD TO ORDER c'+dish.price);
            $("#add_order_popup").on("click",()=>{addToShoppingCart(dish,true);});
        }
        
        function errorMessage(status,place){
            error=status;
            switch(status){
                case 401: error= "Usuario no registrado"; break;
                case 403: case 405: error="Usuario no autorizado"; break;                
                case 404: error= "Registro no encontrado"; break;
                case 111: error="Debes Completar los Espacios Requeridos"; break;
                case 222: error="La cantidad no puede ser menor"; break;
                case 333: error="La cantidad no puede ser menor a 1"; break;
            };            
            place.html('<div class="alert alert-danger fade show">' +
            '<button type="button" class="close" data-dismiss="alert">' +
            '&times;</button><h4 class="alert-heading">Error!</h4>'+error+'</div>');
            return;        
        }
        
    </script>
</body>
</html>
